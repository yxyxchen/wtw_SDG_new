<<<<<<< HEAD
=======
realParas[,1] = rep(seq(0.01, 0.05, length.out = 5), nValue^(nPara - 1)) # phi
realParas[,2] = rep(rep(seq(0, 10, length.out = 5), each = nValue), nValue^(nPara - 2)) # tau
realParas[,3] = rep(seq(0.8, 0.98, length.out = 5), each = nValue^2)
dir.create("genData/simulation/monteCfd")
nRep = 5
simIdx = t(matrix(1 : (nComb * nRep), nRep, nComb))
save("realParas", "nComb", "nValue", "nPara", "paraNames", "nRep", "simIdx", file = "genData/simulation/monteCfd/realParas.RData")
# this script analysized the simulation data on the group level
modelName = "monte"
load(sprintf("genData/simulation/%s/realParas.RData", modelName)) # for nComb, paraNames, nPara
# generally loading
library("ggplot2")
library("dplyr")
library("tidyr")
source(file = './subFxs/plotThemes.R')
load("wtwSettings.RData")
# specific loading
library('scales')
source('subFxs/analysisFxs.R')
load(sprintf("genData/simulation/%s/trialHPData.RData", modelName)) # trialHPData
load(sprintf("genData/simulation/%s/trialLPData.RData", modelName)) # trialLPData
nRep = 5
# trial-level analysis
plotTrialwiseData = F
plotKMSC = F
plotWTW = F
# loop over conditions
for(cIdx in 1 : 2){
cond = conditions[cIdx]
if(cIdx == 1){
trialData = trialHPData
}else{
trialData = trialLPData
}
# generate arguments for later analysis
tMax = tMaxs[cIdx]
kmGrid = seq(0, tMax, by=0.1)
# initialize outputs
totalEarnings_ = matrix(0, nComb, nRep)
AUC_ = matrix(0, nComb, nRep)
# loop over combIdx
for(combIdx in 1 : nComb){
# loop over repetitions
for(rIdx in 1 : nRep){
# select data
thisTrialData = trialData[[simIdx[combIdx, rIdx]]]
realPara = realParas[combIdx,]
# generate arguments for later analysis
label = sprintf('%s %s', conditions[cIdx], paste0(paraNames, realPara, collapse = " "))
# summarise totalEarnings
totalEarnings_[combIdx, rIdx] =  sum(thisTrialData$trialEarnings)
# plot trial-by-trial data
if (plotTrialwiseData) {
trialPlots(thisTrialData,label)
}
# survival analysis
kmscResults = kmsc(thisTrialData,tMax,label,plotKMSC,kmGrid)
AUC_[combIdx, rIdx] = kmscResults[['auc']]
# WTW time series
wtwCeiling = tMax
wtwtsResults = wtwTS(thisTrialData, tGrid, wtwCeiling, label, plotWTW)
}# end of repetitions
}# end of para combinations
# organize and save blockData
AUC = rowSums(AUC_) / nRep
totalEarnings = rowSums(totalEarnings_) / nRep
blockData = data.frame(id = 1 : combIdx, blockNum = rep(1, nComb),
condition = factor(rep(cond, each = nComb), levels = c("HP", "LP")),
AUC = AUC,
totalEarnings = totalEarnings)
if(cIdx == 1){
blockHPData = blockData
}else{
blockLPData = blockData
}
}
wtwtsResults = wtwTS(thisTrialData, tGrid, wtwCeiling, label, plotWTW)
thisTrialData$sellTime
wtwtsResults = wtwTS(thisTrialData, tGrid, wtwCeiling, label, plotWTW)
blockData= thisTrialData
trialWTW = numeric(length = length(blockData$trialEarnings)) # initialize the per-trial estimate of WTW
quitIdx = blockData$trialEarnings == 0
# use either the rewardTime (for reward trials) or time waited (for quit trials)
#   (not using time waited for reward trials because this includes the post-reward RT)
timeWaited = blockData$scheduledWait # use rewardtime make more sense but sometime nan
timeWaited[quitIdx] = blockData$timeWaited[quitIdx]
### find the longest time waited up through the first quit trial
#   (or, if there were no quit trials, the longest time waited at all)
#   that will be the WTW estimate for all trials prior to the first quit
firstQuit = which(quitIdx)[1]
if (is.na(firstQuit)) {firstQuit = length(blockData$trialEarnings)} # if no quit, set to the last trial
currentWTW = max(timeWaited[1:firstQuit])
thisTrialIdx = firstQuit - 1
trialWTW[1:thisTrialIdx] = currentWTW
### iterate through the remaining trials, updating currentWTW
while (thisTrialIdx < length(blockData$trialEarnings)) {
thisTrialIdx = thisTrialIdx + 1
if (quitIdx[thisTrialIdx]) {currentWTW = timeWaited[thisTrialIdx]}
else {currentWTW = max(currentWTW, timeWaited[thisTrialIdx])}
trialWTW[thisTrialIdx] = currentWTW
}
### impose a ceiling value, since trial durations exceeding some value may be infrequent
trialWTW = pmin(trialWTW, wtwCeiling)
### convert from per-trial to per-second over the course of the block
timeWTW = numeric(length = length(tGrid)) # initialize output
binStartIdx = 1
thisTrialIdx = 0
while (thisTrialIdx < length(blockData$trialEarnings)) {
thisTrialIdx = thisTrialIdx + 1
binEndTime = blockData$sellTime[thisTrialIdx]
binEndIdx = max(which(tGrid < binEndTime)) # last grid point that falls within this trial
timeWTW[binStartIdx:binEndIdx] = trialWTW[thisTrialIdx]
binStartIdx = binEndIdx + 1
}
blockData$sellTime[thisTrialIdx]
max(which(tGrid < binEndTime))
which(tGrid < binEndTime)
source('~/Documents/first_kick/wtw_SDG_new/subFxs/analysisFxs.R', echo=TRUE)
# this script analysized the simulation data on the group level
modelName = "monte"
load(sprintf("genData/simulation/%s/realParas.RData", modelName)) # for nComb, paraNames, nPara
############ load data and functions #########
# generally loading
library("ggplot2")
library("dplyr")
library("tidyr")
source(file = './subFxs/plotThemes.R')
load("wtwSettings.RData")
# specific loading
library('scales')
source('subFxs/analysisFxs.R')
load(sprintf("genData/simulation/%s/trialHPData.RData", modelName)) # trialHPData
load(sprintf("genData/simulation/%s/trialLPData.RData", modelName)) # trialLPData
nRep = 5
# trial-level analysis
plotTrialwiseData = F
plotKMSC = F
plotWTW = F
# loop over conditions
for(cIdx in 1 : 2){
cond = conditions[cIdx]
if(cIdx == 1){
trialData = trialHPData
}else{
>>>>>>> fde1ed19abcb41b0175675140772511f5ecbf4db
trialData = trialLPData
}
# generate arguments for later analysis
tMax = tMaxs[cIdx]
kmGrid = seq(0, tMax, by=0.1)
# initialize outputs
totalEarnings_ = matrix(0, nComb, nRep)
AUC_ = matrix(0, nComb, nRep)
# loop over combIdx
for(combIdx in 1 : nComb){
# loop over repetitions
for(rIdx in 1 : nRep){
# select data
thisTrialData = trialData[[simIdx[combIdx, rIdx]]]
realPara = realParas[combIdx,]
# generate arguments for later analysis
label = sprintf('%s %s', conditions[cIdx], paste0(paraNames, realPara, collapse = " "))
# summarise totalEarnings
totalEarnings_[combIdx, rIdx] =  sum(thisTrialData$trialEarnings)
# plot trial-by-trial data
if (plotTrialwiseData) {
trialPlots(thisTrialData,label)
}
# survival analysis
kmscResults = kmsc(thisTrialData,tMax,label,plotKMSC,kmGrid)
AUC_[combIdx, rIdx] = kmscResults[['auc']]
# WTW time series
wtwCeiling = tMax
wtwtsResults = wtwTS(thisTrialData, tGrid, wtwCeiling, label, plotWTW)
}# end of repetitions
}# end of para combinations
# organize and save blockData
AUC = rowSums(AUC_) / nRep
totalEarnings = rowSums(totalEarnings_) / nRep
blockData = data.frame(id = 1 : combIdx, blockNum = rep(1, nComb),
condition = factor(rep(cond, each = nComb), levels = c("HP", "LP")),
AUC = AUC,
totalEarnings = totalEarnings)
if(cIdx == 1){
blockHPData = blockData
}else{
blockLPData = blockData
}
}
blockData = data.frame(rbind(blockHPData, blockLPData), rbind(realParas))
colnames(blockData)[(ncol(blockData) - nPara + 1) : ncol(blockData) ] = paraNames
<<<<<<< HEAD
View(blockData)
thisTrialData = trialHPData[[1]]
View(thisTrialData)
thisTrialData$timeWaited
sum(thisTrialData$trialEarnings)
source('~/Documents/first_kick/wtw_SDG_new/subFxs/simulationFxs.R')
source('~/Documents/first_kick/wtw_SDG_new/subFxs/simulationFxs.R')
getModelFun("monteRatio")
getModelFun("monteRatio")
source('~/Documents/first_kick/wtw_SDG_new/subFxs/simulationFxs.R')
getModelFun("monteRatio")
modelName = "monteRP"
pars = c("phiR", "phiP", "tau", "gamma")
dir.create("genData")
dir.create("genData/expModelFitting")
dir.create("genData/expModelFitting/monteRP")
#  load libraries and set environments
options(warn=-1, message =-1) # default settings borrowed somewhere
library('plyr'); library(dplyr); library(ggplot2);library('tidyr');library('rstan') #load libraries
Sys.setenv(USE_CXX14=1) # making rstan working on this device
rstan_options(auto_write = TRUE) # default settings borrowed somewhere
options(mc.cores = parallel::detectCores())# enable multi-core precessors
library("loo")
# source scripts
source('subFxs/modelFittingFxs.R') # for fitting single case
source('subFxs/wtwSettings.R')
source('subFxs/loadFxs.R') # for load data
# compile the stan model
dir.create(sprintf("genData/expModelFitting/%s", modelName))
model = stan_model(file = sprintf("%s.stan", modelName))
# compile the stan model
dir.create(sprintf("genData/expModelFitting/%s", modelName))
model = stan_model(file = sprintf("stanModels/%s.stan", modelName))
# compile the stan model
dir.create(sprintf("genData/expModelFitting/%s", modelName))
model = stan_model(file = sprintf("stanModels/%s.stan", modelName))
# compile the stan model
dir.create(sprintf("genData/expModelFitting/%s", modelName))
model = stan_model(file = sprintf("stanModels/%s.stan", modelName))
# load expData
allData = loadAllData()
hdrData = allData$hdrData
trialData = allData$trialData
# list with a named element for each subject ID.
allIDs = hdrData$ID                   # column of subject IDs
n = length(allIDs)                    # n
trialData = trialData[(1 : length(trialData)) %in% allIDs]
timeWaitedList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = tempt$timeWaited[1 : sum(tempt$blockNum == 1)]
})
trialEarningsList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = tempt$trialEarnings[1 : sum(tempt$blockNum == 1)]
})
scheduledWaitList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = tempt$scheduledWait[1 : sum(tempt$blockNum == 1)]
})
condList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = unique(tempt$condition)
})
wIniList = ifelse(condList == "HP", wInis[1], wInis[2])
timeWaitedList = sapply(1:n, function(sIdx){
ifelse(trialEarningsList[[sIdx]] > 0, scheduledWaitList[[sIdx]], timeWaitedList[[sIdx]])
})
# loop over suvject
for(sIdx in 1 : n){
wIni = wIniList[[sIdx]]
cond = condList[[sIdx]]
trialEarnings= trialEarningsList[[sIdx]]
timeWaited = timeWaitedList[[sIdx]]
fileName = sprintf("genData/expModelFitting/%s/s%d", modelName, sIdx)
modelFitting(cond, wIni, timeWaited, trialEarnings, fileName, pars, model)
}
expModelFitting("monteRP", pars)
source('~/Documents/first_kick/wtw_SDG_new/expModelFitting.R')
expModelFitting("monteRP", pars)
pars
#  load libraries and set environments
options(warn=-1, message =-1) # default settings borrowed somewhere
library('plyr'); library(dplyr); library(ggplot2);library('tidyr');library('rstan') #load libraries
Sys.setenv(USE_CXX14=1) # making rstan working on this device
rstan_options(auto_write = TRUE) # default settings borrowed somewhere
options(mc.cores = parallel::detectCores())# enable multi-core precessors
library("loo")
# source scripts
source('subFxs/modelFittingFxs.R') # for fitting single case
source('subFxs/wtwSettings.R')
source('subFxs/loadFxs.R') # for load data
# compile the stan model
dir.create(sprintf("genData/expModelFitting/%s", modelName))
model = stan_model(file = sprintf("stanModels/%s.stan", modelName))
# load expData
allData = loadAllData()
hdrData = allData$hdrData
trialData = allData$trialData
# list with a named element for each subject ID.
allIDs = hdrData$ID                   # column of subject IDs
n = length(allIDs)                    # n
trialData = trialData[(1 : length(trialData)) %in% allIDs]
timeWaitedList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = tempt$timeWaited[1 : sum(tempt$blockNum == 1)]
})
trialEarningsList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = tempt$trialEarnings[1 : sum(tempt$blockNum == 1)]
})
scheduledWaitList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = tempt$scheduledWait[1 : sum(tempt$blockNum == 1)]
})
condList = sapply(1 :n, function(sIdx) {
tempt = trialData[[sIdx]]
junk = unique(tempt$condition)
})
wIniList = ifelse(condList == "HP", wInis[1], wInis[2])
timeWaitedList = sapply(1:n, function(sIdx){
ifelse(trialEarningsList[[sIdx]] > 0, scheduledWaitList[[sIdx]], timeWaitedList[[sIdx]])
})
# loop over suvject
for(sIdx in 1 : n){
wIni = wIniList[[sIdx]]
cond = condList[[sIdx]]
trialEarnings= trialEarningsList[[sIdx]]
timeWaited = timeWaitedList[[sIdx]]
fileName = sprintf("genData/expModelFitting/%s/s%d", modelName, sIdx)
modelFitting(cond, wIni, timeWaited, trialEarnings, fileName, pars, model)
}
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteBias")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
# this script extract waic for all models.
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteRP")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
fileName
# this script extract waic for all models.
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteRP")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
# this script extract waic for all models.
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteRP")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
# this script extract waic for all models.
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteRP")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
# this script extract waic for all models.
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteRP")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
# this script extract waic for all models.
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteRP")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
# this script extract waic for all models.
library("R.matlab")
n = 120
nModel = 2
modelNames = c("monte", "monteRP")
waicList = matrix(NA, n, nModel)
for(m in 1 : nModel){
modelName = modelNames[m]
waic = vector(length = n)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.RData", modelName, sIdx)
load(fileName)
waic[sIdx] = WAIC$waic
}
waicList[,m] = waic
}
f= "genData/expModelFitting/waicList.mat"
writeMat(f, waicList = waicList)
waicList
n = 120
modelName = "monteRP"
sIdx = 1
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
trialData[[sIdx]] = read.csv(fileName)
trialData = vector("list", length = n)
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
trialData[[sIdx]] = read.csv(fileName)
trialData[[sIdx]]
a =  trialData[[sIdx]]
View(a)
mean(trialData[[sIdx]])
apply(trialData[[sIdx]], MARGIN = 1, mean)
apply(trialData[[sIdx]], MARGIN = 2, mean)
n = 120
modelName = "monteRP"
samplePara = vector("list", length = n)
summaryPara = matrix(NA, n, 5)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
samplePara[[sIdx]] = read.csv(fileName)
summaryPara[sIdx, ] = apply(trialData[[sIdx]], MARGIN = 2, mean)
}
summaryPara[sIdx, ] = apply(trialData[[sIdx]], MARGIN = 2, mean)
summaryPara = data.frame(NA, n, 5)
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
samplePara[[sIdx]] = read.csv(fileName)
summaryPara[sIdx, ] = apply(trialData[[sIdx]], MARGIN = 2, mean)
}
summaryPara[sIdx, ]
apply(trialData[[sIdx]], MARGIN = 2, mean)
apply(trialData[[sIdx]], MARGIN = 2, mean)
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
samplePara[[sIdx]] = read.csv(fileName)
trialData[[sIdx]]
sIdx
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
samplePara[[sIdx]] = read.csv(fileName)
samplePara[[sIdx]]
n = 120
modelName = "monteRP"
samplePara = vector("list", length = n)
summaryPara = data.frame("phiR" = vector(n), "phiP" = vector(n),
"tau" = vector(n), "gamma" = vector(n))
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
samplePara[[sIdx]] = read.csv(fileName)
summaryPara[sIdx, ] = apply(samplePara[[sIdx]] , MARGIN = 2, mean)
}
summaryPara = data.frame("phiR" = vector(n), "phiP" = vector(n),
"tau" = vector(n), "gamma" = vector(n))
summaryPara = data.frame("phiR" = vector(NA,n), "phiP" = vector(NA,n),
"tau" = vector(NA,n), "gamma" = vector(NA,n))
summaryPara = data.frame("phiR" = vector(length = n), "phiP" = vector(length = n),
"tau" = vector(length = n), "gamma" = vector(length = n))
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
samplePara[[sIdx]] = read.csv(fileName)
summaryPara[sIdx, ] = apply(samplePara[[sIdx]] , MARGIN = 2, mean)
}
warnings()
View(summaryPara)
apply(samplePara[[sIdx]] , MARGIN = 2, mean)
summaryPara[sIdx, ] = apply(samplePara[[sIdx]] , MARGIN = 2, mean)
samplePara = vector("list", length = n)
summaryPara = data.frame("phiR" = vector(length = n), "phiP" = vector(length = n),
"tau" = vector(length = n), "gamma" = vector(length = n),
"LL_all" = vector(length = n))
for(sIdx in 1 : n){
fileName = sprintf("genData/expModelFitting/%s/s%d.txt", modelName, sIdx)
samplePara[[sIdx]] = read.csv(fileName)
summaryPara[sIdx, ] = apply(samplePara[[sIdx]] , MARGIN = 2, mean)
}
hist(summaryPara$phiR)
hist(summaryPara$phiR)
hist(summaryPara$phiP)
library(ggplot2)
ggplot(summaryPara, aes(phiR, phiP)) + geom_point()
ggplot(summaryPara, aes(phiR, phiP)) + geom_point() + xlim(c(0,0.7)) +
ylim(c(0, 0.7)) + geom_abline(slope = 1, yintercept = 0)
library(ggplot2)
ggplot(summaryPara, aes(phiR, phiP)) + geom_point() + xlim(c(0,0.2)) +
ylim(c(0, 0.2)) + geom_abline(slope = 1, yintercept = 0)
load('genData/expDataAnalysis/blockData.RData')
dir.create("genData/expDataAnalysis")
# load libraries
source('subFxs/loadFxs.R') # for loading data
source('subFxs/analysisFxs.R') # for analysis
source("subFxs/plotThemes.R")
=======
ggplot(blockData, aes(totalEarnings)) + geom_histogram(bins = 15) +
facet_wrap(~condition, nrow = 1) + xlab('Total earnings') + ylab("Num of simulations") + saveTheme + xlim(c(0, 600))
fileName = sprintf("figures/simDataAnalysis/totalEarnings.pdf")
ggsave(fileName, width = 16, height = 8)
# calculate range
dplyr::summarise(group_by(blockData, condition),
minEarning = min(totalEarnings),
maxEarning = max(totalEarnings))
############ summarise para effects on total earnings ###########
paraValues = 1:5
paraData = data.frame(condition = rep(c("HP", "LP"), each = nValue, nPara),
paraNames = rep(paraNames, each = nValue * 2),
paraValues = rep(paraValues, nPara * 2))
paraData$paraNames = factor(paraData$paraNames, levels = paraNames)
# summarise mu
muByPhi = summarise_at(group_by(blockData, condition, phi), vars(AUC:totalEarnings), mean)
muByTau = summarise_at(group_by(blockData, condition, tau), vars(AUC:totalEarnings), mean)
muByGamma = summarise_at(group_by(blockData, condition, gamma), vars(AUC:totalEarnings), mean)
# summarise sd
stdByPhi = summarise_at(group_by(blockData, condition, phi), vars(AUC:totalEarnings), sd)
stdByTau = summarise_at(group_by(blockData, condition, tau), vars(AUC:totalEarnings), sd)
stdByGamma = summarise_at(group_by(blockData, condition, gamma), vars(AUC:totalEarnings), sd)
#
mu = rbind(muByPhi, muByTau, muByGamma);
mu = mu[, 3:4]
std = rbind(stdByPhi, stdByTau, stdByGamma)
std = std[,3:4]
max= mu + std
min = mu -std
summaryEarnData = cbind(paraData, mu[,2], std[,2], max[,2], min[,2]);
summaryAUCData = cbind(paraData, mu[,1], std[,1], max[,1], min[,1]);
colnames(summaryEarnData) = c(colnames(paraData), 'mu', 'std', 'max', 'min')
colnames(summaryAUCData) = c(colnames(paraData), 'mu', 'std', 'max', 'min')
# plot
for(c in 1:2){
cond = conditions[c]
ggplot(summaryAUCData[summaryAUCData$condition == cond,], aes(factor(paraValues), mu)) +
geom_bar(stat = "identity", width=0.5, fill = conditionColors[c]) + geom_errorbar(aes(ymin = min, ymax = max), width=.2)+
facet_wrap(~paraNames, nrow = 1)+ saveTheme +
xlab("Parameter value") + ylab("AUC / s") + ggtitle(cond)
fileName = sprintf("figures/simDataAnalysis/paraAUCEffect%s.pdf", cond)
ggsave(fileName, width = 16, height = 8)
}
# plot
for(c in 1:2){
cond = conditions[c]
ggplot(summaryEarnData[summaryEarnData$condition == cond,], aes(factor(paraValues), mu)) +
geom_bar(stat = "identity", width=0.5, fill = conditionColors[c]) + geom_errorbar(aes(ymin = min, ymax = max), width=.2)+
facet_wrap(~paraNames, nrow = 1)+ saveTheme +
xlab("Parameter value") + ylab("Total Earnings") + ggtitle(cond)
fileName = sprintf("figures/simDataAnalysis/paraEarnEffect%s.pdf", cond)
ggsave(fileName, width = 16, height = 8)
}
######### plot AUC against totalEarnings #######
# prepare data
plotData = rbind(as.data.frame(colpHPData[c(1,3)]),
as.data.frame(colpLPData[c(1,3)]))
plotData$condition = rep(c('HP', 'LP'), each = length(colpHPData$totalEarnings))
plotData = plotData %>% arrange(totalEarnings) %>%group_by(condition) %>%
mutate(earningRank = rank(totalEarnings, ties.method = "first"))
# plot for LP
ggplot(plotData[plotData$condition == 'LP',], aes(AUC, totalEarnings)) + geom_point(size = 1.5) +
saveTheme + ylab('Total earnings') + xlim(c(0, tMaxs[2])) + ylim(c(0, 500))
fileName = file.path(outFile, "AUCLP_earningsLP.pdf")
ggsave(fileName, width = 6, height = 4)
# plot for HP
ggplot(plotData[plotData$condition == 'HP',], aes(AUC, totalEarnings)) + geom_point(size = 1.5) +
saveTheme + ylab('Total earnings') + xlim(c(0, tMaxs[1])) + ylim(c(0, 500))
fileName = file.path(outFile, "AUCHP_earningsHP.pdf")
ggsave(fileName, width = 6, height = 4)
######## plot the timeseries of wtw #######
meanValues = c(apply(rawWTW$HP, MARGIN = 3, FUN = mean),
apply(rawWTW$LP, MARGIN = 3, FUN = mean))
stdValues = c(apply(rawWTW$HP, MARGIN = 3, FUN = sd),
apply(rawWTW$LP, MARGIN = 3, FUN = sd))
plotData = data.frame(meanValues, stdValues,
time = rep(tGrid, time = 2),
condition = rep(c('HP', 'LP'), each = length(tGrid)),
minValues = meanValues - stdValues / sqrt(dim(rawWTW$HP)[1]),
maxValues = meanValues + stdValues / sqrt(dim(rawWTW$HP)[1]))
ggplot(plotData, aes(time, meanValues, color = condition)) +
geom_ribbon(data = plotData[plotData$condition == 'HP',], aes(ymin=minValues, ymax=maxValues),linetype=0, alpha = 0.1, color = "#bababa") +
geom_ribbon(data = plotData[plotData$condition == 'LP',], aes(ymin=minValues, ymax=maxValues),linetype=0, alpha = 0.1, color = "#bababa") +
geom_line(size = 1) + xlab('Time in block / s') + ylab('WTW / s') + saveTheme
fileName = file.path(outFile, "wtwTimeSeries.pdf")
ggsave(fileName, width = 12, height = 8)
########### plot HPAUC against LPAUC ##############
plotData = data.frame(HPAUC = colpHPData$AUC, LPAUC = colpLPData$AUC)
ggplot(plotData, aes(HPAUC, LPAUC)) + geom_point(shape = 3 ) + geom_smooth(method = lm) +
xlab('HP AUC/s') + ylab("LP AUC /s") + saveTheme
fileName = file.path(outFile, "HPAUC_LPAUC.pdf")
ggsave(fileName, width = 8, height = 8)
plotData = blockData %>% arrange(totalEarnings) %>%group_by(condition) %>%
mutate(earningRank = rank(totalEarnings, ties.method = "first"))
ggplot(plotData[plotData$condition == 'LP',], aes(AUC, totalEarnings)) + geom_point(size = 1.5) +
saveTheme + ylab('Total earnings') + xlim(c(0, tMaxs[2])) + ylim(c(0, 500))
fileName = file.path(outFile, "AUCLP_earningsLP.pdf")
# plot for HP
ggplot(plotData[plotData$condition == 'HP',], aes(AUC, totalEarnings)) + geom_point(size = 1.5) +
saveTheme + ylab('Total earnings') + xlim(c(0, tMaxs[1])) + ylim(c(0, 500))
fileName = "figures/simDataAnalysis/AUCLP_earningsHP.pdf"
ggsave(fileName, width = 6, height = 4)
ggplot(plotData[plotData$condition == 'LP',], aes(AUC, totalEarnings)) + geom_point(size = 1.5) +
saveTheme + ylab('Total earnings') + xlim(c(0, tMaxs[2])) + ylim(c(0, 500))
fileName = "figures/simDataAnalysis/AUCLP_earningsLP.pdf"
ggsave(fileName, width = 6, height = 4)
plotData = data.frame(HPAUC = colpHPData$AUC, LPAUC = colpLPData$AUC)
ggplot(plotData, aes(HPAUC, LPAUC)) + geom_point(shape = 3 ) + geom_smooth(method = lm) +
xlab('HP AUC/s') + ylab("LP AUC /s") + saveTheme
fileName = fileName = "figures/simDataAnalysis/HPAUC_LPAUC.pdf"
ggsave(fileName, width = 8, height = 8)
########### plot HPAUC against LPAUC ##############
plotData = data.frame(HPAUC = blockHPData$AUC, LPAUC = blockLPData$AUC)
ggplot(plotData, aes(HPAUC, LPAUC)) + geom_point(shape = 3 ) + geom_smooth(method = lm) +
xlab('HP AUC/s') + ylab("LP AUC /s") + saveTheme
fileName = fileName = "figures/simDataAnalysis/HPAUC_LPAUC.pdf"
ggsave(fileName, width = 8, height = 8)
simulation("monteCfd")
source('~/Documents/first_kick/wtw_SDG_new/simulation.R', echo=TRUE)
simulation("monteCfd")
# this script analysized the simulation data on the group level
modelName = "monteCfd"
load(sprintf("genData/simulation/%s/realParas.RData", modelName)) # for nComb, paraNames, nPara
############ load data and functions #########
# generally loading
>>>>>>> fde1ed19abcb41b0175675140772511f5ecbf4db
library("ggplot2")
library('dplyr')
# library(Hmisc)
# load setting parameters
load("wtwSettings.RData")
<<<<<<< HEAD
# load all data
allData = loadAllData()
hdrData = allData$hdrData
trialData = allData$trialData
# list with a named element for each subject ID.
allIDs = hdrData$ID                   # column of subject IDs
n = length(allIDs)                    # n
nBlock = 3
cat('Analyzing data for n','=',n,'subjects.\n')
# control which individual-level plots to generate
plotTrialwiseData = F
plotKMSC = F
plotWTW = F
plotTimeEarnings = F   # no good effect
plotTrialEarnings =  F  # no good effect
# initialize outputs, organised by block
tGrid = seq(0, blockSecs, by = 0.1)
AUC = numeric(length =n * nBlock)
totalEarnings =  numeric(length =n * nBlock)
# descriptive statistics for individual subjects and blocks
for (sIdx in 1:n) {
thisID = allIDs[sIdx]
for (bkIdx in 1:nBlock){
# select data
thisTrialData = trialData[[thisID]]
thisBlockIdx = (thisTrialData$blockNum == bkIdx)
thisTrialData = thisTrialData[thisBlockIdx,]
# generate arguments for later analysis
label = sprintf('Subject %s, Cond %s, Stress %s)',thisID, hdrData$condition[sIdx], hdrData$stress[sIdx])
noIdx = (sIdx - 1) * nBlock + bkIdx #
tMax = ifelse(hdrData$condition[sIdx] == conditions[1], tMaxs[1], tMaxs[2])
kmGrid = seq(0, tMax, by=0.1) # grid on which to average survival curves.
# calcualte totalEarnings
totalEarnings[noIdx] =  sum(thisTrialData$trialEarnings)
=======
# specific loading
library('scales')
source('subFxs/analysisFxs.R')
load(sprintf("genData/simulation/%s/trialHPData.RData", modelName)) # trialHPData
load(sprintf("genData/simulation/%s/trialLPData.RData", modelName)) # trialLPData
nRep = 5
# trial-level analysis
plotTrialwiseData = F
plotKMSC = F
plotWTW = F
# loop over conditions
for(cIdx in 1 : 2){
cond = conditions[cIdx]
if(cIdx == 1){
trialData = trialHPData
}else{
trialData = trialLPData
}
# generate arguments for later analysis
tMax = tMaxs[cIdx]
kmGrid = seq(0, tMax, by=0.1)
# initialize outputs
totalEarnings_ = matrix(0, nComb, nRep)
AUC_ = matrix(0, nComb, nRep)
# loop over combIdx
for(combIdx in 1 : nComb){
# loop over repetitions
for(rIdx in 1 : nRep){
# select data
thisTrialData = trialData[[simIdx[combIdx, rIdx]]]
realPara = realParas[combIdx,]
# generate arguments for later analysis
label = sprintf('%s %s', conditions[cIdx], paste0(paraNames, realPara, collapse = " "))
# summarise totalEarnings
totalEarnings_[combIdx, rIdx] =  sum(thisTrialData$trialEarnings)
>>>>>>> fde1ed19abcb41b0175675140772511f5ecbf4db
# plot trial-by-trial data
if (plotTrialwiseData) {
trialPlots(thisTrialData,label)
}
# survival analysis
kmscResults = kmsc(thisTrialData,tMax,label,plotKMSC,kmGrid)
<<<<<<< HEAD
AUC[noIdx] = kmscResults[['auc']]
# WTW time series
wtwCeiling = tMax
wtwtsResults = wtwTS(thisTrialData, tGrid, wtwCeiling, label, plotWTW)
# accumutative timeEarnings
timeEarnings = getTimeEarnings(thisTrialData, tGrid, label, plotTimeEarnings)
# accumutative trialEarnings
plotData = data.frame(trialNum = thisTrialData$trialNum,
cumEarnings = cumsum(thisTrialData$trialEarnings))
if(plotTrialEarnings){
p = ggplot(plotData, aes(trialNum, cumEarnings)) + geom_line()
print(p)
}
# wait for input before continuing, if individual plots were requested
if (any(plotTrialwiseData, plotKMSC, plotWTW, plotTimeEarnings, plotTrialEarnings)) {
readline(prompt = paste('subject',thisID, "block", bkIdx, '(hit ENTER to continue)'))
graphics.off()
=======
AUC_[combIdx, rIdx] = kmscResults[['auc']]
# WTW time series
wtwCeiling = tMax
wtwtsResults = wtwTS(thisTrialData, tGrid, wtwCeiling, label, plotWTW)
}# end of repetitions
}# end of para combinations
# organize and save blockData
AUC = rowSums(AUC_) / nRep
totalEarnings = rowSums(totalEarnings_) / nRep
blockData = data.frame(id = 1 : combIdx, blockNum = rep(1, nComb),
condition = factor(rep(cond, each = nComb), levels = c("HP", "LP")),
AUC = AUC,
totalEarnings = totalEarnings)
if(cIdx == 1){
blockHPData = blockData
}else{
blockLPData = blockData
>>>>>>> fde1ed19abcb41b0175675140772511f5ecbf4db
}
} # loop over blocks
}
<<<<<<< HEAD
# organize and save blockWiseData
blockData = data.frame(id = rep(allIDs, each = nBlock), blockNum = rep( t(1 : nBlock), n),
cbal = rep(hdrData$cbal, each = nBlock), condition = factor(rep(hdrData$condition, each = nBlock), levels = c("HP", "LP")),
stress = factor(rep(hdrData$stress, each = nBlock), levels = c("no stress", "stress")), AUC = AUC,
totalEarnings = totalEarnings)
save(blockData, file = 'genData/expDataAnalysis/blockData.RData')
plotData = cbind(summaryPara, blockData[blockData$blockNum == 1])
plotData = cbind(summaryPara, blockData[blockData$blockNum == 1, ])
summaryPara$optimism = summaryPara$phiR - summaryPara$phiP
ggplot(plotData, aes(optimism, AUC)) + geom_point() + facet_grid(~condition)
plotData = cbind(summaryPara, blockData[blockData$blockNum == 1, ])
ggplot(plotData, aes(optimism, AUC)) + geom_point() + facet_grid(~condition)
plotData = cbind(summaryPara, blockData[blockData$blockNum == 2, ])
ggplot(plotData, aes(optimism, AUC)) + geom_point() + facet_grid(~condition)
plotData = cbind(summaryPara, blockData[blockData$blockNum == 3, ])
ggplot(plotData, aes(optimism, AUC)) + geom_point() + facet_grid(~condition)
plotData = cbind(summaryPara, blockData[blockData$blockNum == 1, ])
ggplot(plotData, aes(optimism, AUC)) + geom_point() + facet_grid(~condition)
### relation ship between AUC and
plotData = cbind(summaryPara, blockData[blockData$blockNum == 2, ])
ggplot(plotData, aes(optimism, AUC)) + geom_point() + facet_grid(~condition)
### relation ship between AUC and
plotData = cbind(summaryPara, blockData[blockData$blockNum == 3, ])
ggplot(plotData, aes(optimism, AUC)) + geom_point() + facet_grid(~condition)
cor.test(plotData$optimism, plotData$AUC)
hist(summaryPara$optimism)
t.test(plotData$optimism[plotData$stress == "stress"],
plotData$optimism[plotData$stress == "no stress"],)
plotData$stress
plotData$optimism[plotData$stress == "no stress"]
t.test(plotData$optimism[plotData$stress == "stress"],
plotData$optimism[plotData$stress == "no stress"])
t.test(plotData$tau[plotData$stress == "stress"],
plotData$tau[plotData$stress == "no stress"])
t.test(plotData$gamma[plotData$stress == "stress"],
plotData$gamma[plotData$stress == "no stress"])
t.test(plotData$phiR[plotData$stress == "stress"],
plotData$phiR[plotData$stress == "no stress"])
t.test(plotData$phiP[plotData$stress == "stress"],
plotData$phiP[plotData$stress == "no stress"])
=======
dir.create("figures/simDataAnalysis/monteCfd")
####### plot distribution of totalEarnings
blockData = data.frame(rbind(blockHPData, blockLPData), rbind(realParas))
colnames(blockData)[(ncol(blockData) - nPara + 1) : ncol(blockData) ] = paraNames
ggplot(blockData, aes(totalEarnings)) + geom_histogram(bins = 15) +
facet_wrap(~condition, nrow = 1) + xlab('Total earnings') + ylab("Num of simulations") + saveTheme + xlim(c(0, 600))
fileName = sprintf("figures/simDataAnalysis/%s/totalEarnings.pdf", modelName)
ggsave(fileName, width = 16, height = 8)
# calculate range
dplyr::summarise(group_by(blockData, condition),
minEarning = min(totalEarnings),
maxEarning = max(totalEarnings))
############ summarise para effects on total earnings ###########
paraValues = 1:5
paraData = data.frame(condition = rep(c("HP", "LP"), each = nValue, nPara),
paraNames = rep(paraNames, each = nValue * 2),
paraValues = rep(paraValues, nPara * 2))
paraData$paraNames = factor(paraData$paraNames, levels = paraNames)
# summarise mu
muByPhi = summarise_at(group_by(blockData, condition, phi), vars(AUC:totalEarnings), mean)
muByTau = summarise_at(group_by(blockData, condition, tau), vars(AUC:totalEarnings), mean)
muByGamma = summarise_at(group_by(blockData, condition, gamma), vars(AUC:totalEarnings), mean)
# summarise sd
stdByPhi = summarise_at(group_by(blockData, condition, phi), vars(AUC:totalEarnings), sd)
stdByTau = summarise_at(group_by(blockData, condition, tau), vars(AUC:totalEarnings), sd)
stdByGamma = summarise_at(group_by(blockData, condition, gamma), vars(AUC:totalEarnings), sd)
#
mu = rbind(muByPhi, muByTau, muByGamma);
mu = mu[, 3:4]
std = rbind(stdByPhi, stdByTau, stdByGamma)
std = std[,3:4]
max= mu + std
min = mu -std
summaryEarnData = cbind(paraData, mu[,2], std[,2], max[,2], min[,2]);
summaryAUCData = cbind(paraData, mu[,1], std[,1], max[,1], min[,1]);
colnames(summaryEarnData) = c(colnames(paraData), 'mu', 'std', 'max', 'min')
colnames(summaryAUCData) = c(colnames(paraData), 'mu', 'std', 'max', 'min')
# plot
for(c in 1:2){
cond = conditions[c]
ggplot(summaryAUCData[summaryAUCData$condition == cond,], aes(factor(paraValues), mu)) +
geom_bar(stat = "identity", width=0.5, fill = conditionColors[c]) + geom_errorbar(aes(ymin = min, ymax = max), width=.2)+
facet_wrap(~paraNames, nrow = 1)+ saveTheme +
xlab("Parameter value") + ylab("AUC / s") + ggtitle(cond)
fileName = sprintf("figures/simDataAnalysis/%s/paraAUCEffect%s.pdf", modelName, cond)
ggsave(fileName, width = 16, height = 8)
}
# plot
for(c in 1:2){
cond = conditions[c]
ggplot(summaryEarnData[summaryEarnData$condition == cond,], aes(factor(paraValues), mu)) +
geom_bar(stat = "identity", width=0.5, fill = conditionColors[c]) + geom_errorbar(aes(ymin = min, ymax = max), width=.2)+
facet_wrap(~paraNames, nrow = 1)+ saveTheme +
xlab("Parameter value") + ylab("Total Earnings") + ggtitle(cond)
fileName = sprintf("figures/simDataAnalysis/%s/paraEarnEffect%s.pdf",modelName, cond)
ggsave(fileName, width = 16, height = 8)
}
summaryAUCData
mean(summaryAUCData$mu[summaryAUCData$condition == "HP" & summaryAUCData$paraNames == "phi"])
mean(summaryAUCData$mu[summaryAUCData$condition == "HP" & summaryAUCData$paraNames == "c"])
mean(summaryAUCData$mu[summaryAUCData$condition == "HP" & summaryAUCData$paraNames == "gamma"])
muByTau = summarise_at(group_by(blockData, condition, c), vars(AUC:totalEarnings), mean)
paraValues = 1:5
paraData = data.frame(condition = rep(c("HP", "LP"), each = nValue, nPara),
paraNames = rep(paraNames, each = nValue * 2),
paraValues = rep(paraValues, nPara * 2))
paraData$paraNames = factor(paraData$paraNames, levels = paraNames)
# summarise mu
muByPhi = summarise_at(group_by(blockData, condition, phi), vars(AUC:totalEarnings), mean)
muByTau = summarise_at(group_by(blockData, condition, c), vars(AUC:totalEarnings), mean)
muByGamma = summarise_at(group_by(blockData, condition, gamma), vars(AUC:totalEarnings), mean)
# summarise sd
stdByPhi = summarise_at(group_by(blockData, condition, phi), vars(AUC:totalEarnings), sd)
stdByTau = summarise_at(group_by(blockData, condition, tau), vars(AUC:totalEarnings), sd)
stdByGamma = summarise_at(group_by(blockData, condition, gamma), vars(AUC:totalEarnings), sd)
#
mu = rbind(muByPhi, muByTau, muByGamma);
mu = mu[, 3:4]
std = rbind(stdByPhi, stdByTau, stdByGamma)
std = std[,3:4]
max= mu + std
min = mu -std
summaryEarnData = cbind(paraData, mu[,2], std[,2], max[,2], min[,2]);
summaryAUCData = cbind(paraData, mu[,1], std[,1], max[,1], min[,1]);
colnames(summaryEarnData) = c(colnames(paraData), 'mu', 'std', 'max', 'min')
colnames(summaryAUCData) = c(colnames(paraData), 'mu', 'std', 'max', 'min')
# plot
for(c in 1:2){
cond = conditions[c]
ggplot(summaryAUCData[summaryAUCData$condition == cond,], aes(factor(paraValues), mu)) +
geom_bar(stat = "identity", width=0.5, fill = conditionColors[c]) + geom_errorbar(aes(ymin = min, ymax = max), width=.2)+
facet_wrap(~paraNames, nrow = 1)+ saveTheme +
xlab("Parameter value") + ylab("AUC / s") + ggtitle(cond)
fileName = sprintf("figures/simDataAnalysis/%s/paraAUCEffect%s.pdf", modelName, cond)
ggsave(fileName, width = 16, height = 8)
}
# plot
for(c in 1:2){
cond = conditions[c]
ggplot(summaryEarnData[summaryEarnData$condition == cond,], aes(factor(paraValues), mu)) +
geom_bar(stat = "identity", width=0.5, fill = conditionColors[c]) + geom_errorbar(aes(ymin = min, ymax = max), width=.2)+
facet_wrap(~paraNames, nrow = 1)+ saveTheme +
xlab("Parameter value") + ylab("Total Earnings") + ggtitle(cond)
fileName = sprintf("figures/simDataAnalysis/%s/paraEarnEffect%s.pdf",modelName, cond)
ggsave(fileName, width = 16, height = 8)
}
######### plot AUC against totalEarnings #######
# prepare data
plotData = blockData %>% arrange(totalEarnings) %>%group_by(condition) %>%
mutate(earningRank = rank(totalEarnings, ties.method = "first"))
# plot for LP
ggplot(plotData[plotData$condition == 'LP',], aes(AUC, totalEarnings)) + geom_point(size = 1.5) +
saveTheme + ylab('Total earnings') + xlim(c(0, tMaxs[2])) + ylim(c(0, 500))
fileName = sprintf("figures/simDataAnalysis/%s/AUCLP_earningsLP.pdf", modelName)
ggsave(fileName, width = 6, height = 4)
# plot for HP
ggplot(plotData[plotData$condition == 'HP',], aes(AUC, totalEarnings)) + geom_point(size = 1.5) +
saveTheme + ylab('Total earnings') + xlim(c(0, tMaxs[1])) + ylim(c(0, 500))
fileName = sprintf("figures/simDataAnalysis/%s/AUCLP_earningsHP.pdf", modelName)
ggsave(fileName, width = 6, height = 4)
#  load libraries and set environments
options(warn=-1, message =-1) # default settings borrowed somewhere
library('plyr'); library(dplyr); library(ggplot2);library('tidyr');library('rstan') #load libraries
Sys.setenv(USE_CXX14=1) # making rstan working on this device
rstan_options(auto_write = TRUE) # default settings borrowed somewhere
options(mc.cores = parallel::detectCores())# enable multi-core precessors
library("loo")
# source scripts
source('subFxs/modelFittingFxs.R') # for fitting single case
source('subFxs/wtwSettings.R')
source('subFxs/loadFxs.R') # for load data
lookup("ifelse")
>>>>>>> fde1ed19abcb41b0175675140772511f5ecbf4db
